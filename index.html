<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Scoring Tracker</title>
    <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC8'
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        glow: {
                            'from': { boxShadow: '0 0 5px rgba(93, 92, 222, 0.5)' },
                            'to': { boxShadow: '0 0 20px rgba(93, 92, 222, 0.8)' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-primary dark:text-primary-light">ITV7 Tracker üêé</h1>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    <span id="connectionStatus" class="inline-flex items-center">
                        <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                        Connecting...
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="adminMode" class="sr-only">
                    <div class="relative">
                        <div class="block bg-gray-300 dark:bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform"></div>
                    </div>
                    <span class="ml-3 text-sm font-medium">Admin Mode</span>
                </label>
                <button onclick="addRound()" id="addRoundBtn" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Add Round
                </button>
            </div>
        </div>

        <!-- Scoring Rules -->
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6">
            <h3 class="font-semibold text-sm mb-2">Scoring Rules:</h3>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 text-sm">
                <div class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Win: 3 points</div>
                <div class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>Place: 1 point</div>
                <div class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>Highest Odds: 5 points/ 3 points if shared</div>

            </div>
        </div>

        <!-- Current Standings -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">üèÜ Current Standings üèÜ</h2>
            <div id="dynamicStandings" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Standings will be dynamically generated -->
            </div>
        </div>

        <!-- Charts Toggle Button -->
        <div class="mb-6">
            <button onclick="toggleCharts()" class="w-full sm:w-auto bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                <svg id="chartsIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span id="chartsButtonText">Show Charts & Trends</span>
            </button>
        </div>

        <!-- Rounds Controls -->
        <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">
                <span id="roundsInfo">Showing 1 of ${rounds.length} rounds</span>
            </div>
            <div class="flex gap-2">
                <button onclick="expandAllRounds()" class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded transition-colors">
                    Expand All
                </button>
                <button onclick="collapseAllRounds()" class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded transition-colors">
                    Collapse All
                </button>
            </div>
        </div>

        <!-- Score Table - Mobile Optimized -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
            <!-- Desktop Table -->
            <div class="hidden lg:block overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 dark:text-gray-300 w-16">Round</th>
                            <th colspan="6" class="px-2 py-3 text-center font-medium text-gray-600 dark:text-gray-300 border-l border-gray-200 dark:border-gray-600">Eggman</th>
                            <th colspan="6" class="px-2 py-3 text-center font-medium text-gray-600 dark:text-gray-300 border-l border-gray-200 dark:border-gray-600">George üëë</th>
                            <th colspan="6" class="px-2 py-3 text-center font-medium text-gray-600 dark:text-gray-300 border-l border-gray-200 dark:border-gray-600">Chris</th>
                        </tr>
                        <tr class="bg-gray-100 dark:bg-gray-600">
                            <th class="px-2 py-2"></th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">W</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">P</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">HO</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">B</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">FB</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">Tot</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400 border-l border-gray-200 dark:border-gray-500">W</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">P</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">HO</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">B</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">FB</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">Tot</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400 border-l border-gray-200 dark:border-gray-500">W</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">P</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">HO</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">B</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">FB</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">Tot</th>
                        </tr>
                    </thead>
                    <tbody id="scoreTableBodyDesktop">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="lg:hidden" id="scoreTableMobile">
                <!-- Cards will be added dynamically -->
            </div>
        </div>


    </div>

    <script>
        // Data storage
        let rounds = [];
        let isAdminMode = false;
        let trendChart, favBackerChart;
        let pusher, channel;
        let previousPositions = {}; // Track position changes
        let collapsedRounds = new Set(); // Track which rounds are collapsed

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateCharts();
        });

        // Initialize Pusher connection
        function initPusher() {
            try {
                pusher = new Pusher('34c3cbec9bc210bcb8c0', {
                    cluster: 'eu'
                });

                channel = pusher.subscribe('score-channel');
                
                pusher.connection.bind('connected', function() {
                    updateConnectionStatus('connected');
                });
                
                pusher.connection.bind('disconnected', function() {
                    updateConnectionStatus('disconnected');
                });
                
                pusher.connection.bind('failed', function() {
                    updateConnectionStatus('failed');
                });

                channel.bind('score-updated', function(data) {
                    if (data.scoreData && data.scoreData.rounds) {
                        rounds = data.scoreData.rounds;
                        initializeCollapsedState();
                        updateTable();
                        updateTotals();
                        updateCharts();
                        updateRoundsInfo();
                    }
                });
            } catch (error) {
                console.error('Failed to initialize Pusher:', error);
                updateConnectionStatus('failed');
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const dot = statusElement.querySelector('span');
            
            switch(status) {
                case 'connected':
                    dot.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Connected';
                    break;
                case 'disconnected':
                    dot.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>Disconnected';
                    break;
                case 'failed':
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>Connection Failed';
                    break;
                default:
                    dot.className = 'w-2 h-2 bg-gray-400 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>Connecting...';
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                const response = await fetch('/.netlify/functions/update-score');
                const data = await response.json();
                if (data.scoreData && data.scoreData.rounds) {
                    rounds = data.scoreData.rounds;
                    initializeCollapsedState();
                    updateTable();
                    updateTotals();
                    updateCharts();
                    updateRoundsInfo();
                }
            } catch (error) {
                console.error('Failed to load initial data:', error);
            }
        }

        // Initialize collapsed state - show only the first round
        function initializeCollapsedState() {
            collapsedRounds.clear();
            rounds.forEach((round, index) => {
                if (index > 0) { // Collapse all rounds except the first one
                    collapsedRounds.add(index);
                }
            });
        }

        // Toggle round visibility
        function toggleRound(roundIndex) {
            if (collapsedRounds.has(roundIndex)) {
                collapsedRounds.delete(roundIndex);
            } else {
                collapsedRounds.add(roundIndex);
            }
            updateTable();
            updateRoundsInfo();
        }

        // Expand all rounds
        function expandAllRounds() {
            collapsedRounds.clear();
            updateTable();
            updateRoundsInfo();
        }

        // Collapse all rounds except the first
        function collapseAllRounds() {
            collapsedRounds.clear();
            rounds.forEach((round, index) => {
                if (index > 0) {
                    collapsedRounds.add(index);
                }
            });
            updateTable();
            updateRoundsInfo();
        }

        // Update rounds info
        function updateRoundsInfo() {
            const visibleRounds = rounds.length - collapsedRounds.size;
            const totalRounds = rounds.length;
            document.getElementById('roundsInfo').textContent = `Showing ${visibleRounds} of ${totalRounds} rounds`;
        }

        // Send score update to backend
        async function sendScoreUpdate() {
            if (!isAdminMode) return;
            
            try {
                await fetch('/.netlify/functions/update-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scoreData: { 
                            rounds: rounds,
                            lastUpdated: new Date().toISOString()
                        } 
                    })
                });
            } catch (error) {
                console.error('Failed to send score update:', error);
            }
        }

        // Password modal functions
        function showPasswordModal() {
            const modal = document.createElement('div');
            modal.id = 'passwordModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Admin Access Required</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Please enter the password to enable admin mode:</p>
                    <input type="password" id="passwordInput" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-primary focus:ring-1 focus:ring-primary outline-none mb-4" placeholder="Enter password">
                    <div id="passwordError" class="text-red-500 text-sm mb-4 hidden">LOL, Watersmeet isnt the password! Please try again.</div>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closePasswordModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
                        <button onclick="checkPassword()" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg transition-colors">Submit</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on input and setup enter key handler
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.focus();
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            // Reset toggle if password was wrong
            const adminToggle = document.getElementById('adminMode');
            adminToggle.checked = isAdminMode;
        }

        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const errorDiv = document.getElementById('passwordError');
            const password = passwordInput.value;
            
            if (password === '99') {
                isAdminMode = true;
                updateAdminToggleAppearance(true);
                document.getElementById('addRoundBtn').disabled = false;
                updateTable();
                closePasswordModal();
            } else {
                errorDiv.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function updateAdminToggleAppearance(enabled) {
            const dot = document.querySelector('.dot');
            const bg = document.querySelector('.block');
            if (enabled) {
                dot.style.transform = 'translateX(24px)';
                bg.style.backgroundColor = '#5D5CDE';
            } else {
                dot.style.transform = 'translateX(0)';
                bg.style.backgroundColor = '';
            }
        }

        // Admin mode toggle
        const adminToggle = document.getElementById('adminMode');
        adminToggle.addEventListener('change', function() {
            if (this.checked && !isAdminMode) {
                // Show password modal when trying to enable admin mode
                showPasswordModal();
            } else if (!this.checked && isAdminMode) {
                // Disable admin mode
                isAdminMode = false;
                document.getElementById('addRoundBtn').disabled = true;
                updateAdminToggleAppearance(false);
                updateTable();
            }
        });

        function addRound() {
            if (!isAdminMode) return;
            
            const roundNumber = rounds.length + 1;
            const newRound = {
                round: roundNumber,
                eggman: { win: '', place: '', highestOdds: '', bonus: '', favBacker: false },
                george: { win: '', place: '', highestOdds: '', bonus: '', favBacker: false },
                chris: { win: '', place: '', highestOdds: '', bonus: '', favBacker: false }
            };
            
            rounds.unshift(newRound);
            // Don't collapse the newly added round
            const newCollapsedRounds = new Set();
            collapsedRounds.forEach(index => newCollapsedRounds.add(index + 1));
            collapsedRounds = newCollapsedRounds;
            
            updateTable();
            updateTotals();
            updateCharts();
            updateRoundsInfo();
            sendScoreUpdate();
        }

        function calculateRoundTotal(player) {
            const win = parseInt(player.win) || 0;
            const place = parseInt(player.place) || 0;
            const highestOdds = parseInt(player.highestOdds) || 0;
            const bonus = parseInt(player.bonus) || 0;
            return (win * 3) + (place * 1) + (highestOdds * 1) + bonus;
        }

        function updateRoundData(roundIndex, player, field, value) {
            if (!isAdminMode) return;
            
            // Store current positions before updating
            const currentStandings = getCurrentStandings();
            
            if (field === 'favBacker') {
                rounds[roundIndex][player][field] = value;
            } else {
                rounds[roundIndex][player][field] = value === '' ? '' : (parseInt(value) || '');
            }
            
            // Update previous positions if this is a meaningful change
            if (Object.keys(previousPositions).length === 0) {
                previousPositions = { ...currentStandings };
            }
            
            updateTotals();
            updateCharts();
            sendScoreUpdate();
        }

        function getCurrentStandings() {
            let eggmanTotal = 0, georgeTotal = 0, chrisTotal = 0;
            
            rounds.forEach(round => {
                eggmanTotal += calculateRoundTotal(round.eggman);
                georgeTotal += calculateRoundTotal(round.george);
                chrisTotal += calculateRoundTotal(round.chris);
            });

            const players = [
                { key: 'eggman', total: eggmanTotal },
                { key: 'george', total: georgeTotal },
                { key: 'chris', total: chrisTotal }
            ];

            players.sort((a, b) => b.total - a.total);
            
            const positions = {};
            players.forEach((player, index) => {
                positions[player.key] = index + 1;
            });
            
            return positions;
        }

        function toggleCharts() {
            showChartsModal();
        }

        function showChartsModal() {
            const modal = document.createElement('div');
            modal.id = 'chartsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full h-full max-w-7xl max-h-[90vh] flex flex-col">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 dark:border-gray-600">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-200">Charts & Trends</h2>
                        <button onclick="closeChartsModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="flex-1 overflow-auto p-4 sm:p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6 h-full">
                            <!-- Cumulative Score Trend -->
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 sm:p-6 rounded-lg min-h-[300px] sm:min-h-[400px]">
                                <h3 class="text-base sm:text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Cumulative Score Trend</h3>
                                <div class="relative h-64 sm:h-80">
                                    <canvas id="trendChart" class="w-full h-full"></canvas>
                                </div>
                            </div>
                            
                            <!-- Fav Backer Count -->
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 sm:p-6 rounded-lg min-h-[300px] sm:min-h-[400px]">
                                <h3 class="text-base sm:text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Fav Backer Count</h3>
                                <div class="relative h-64 sm:h-80">
                                    <canvas id="favBackerChart" class="w-full h-full"></canvas>
                                </div>
                            </div>
                            
                            <!-- Average Scores Table -->
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 sm:p-6 rounded-lg min-h-[300px] sm:min-h-[400px] lg:col-span-2 xl:col-span-1">
                                <h3 class="text-base sm:text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Average Scores by Period</h3>
                                <div id="averageScoresTable" class="h-full flex flex-col">
                                    <!-- Table will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeChartsModal();
                }
            });
            
            // Close modal with escape key
            document.addEventListener('keydown', handleEscapeKey);
            
            // Initialize charts and table if they haven't been created yet
            setTimeout(() => {
                if (!trendChart || !favBackerChart) {
                    initCharts();
                }
                updateCharts();
                updateAverageScoresTable();
            }, 100);
        }

        function closeChartsModal() {
            const modal = document.getElementById('chartsModal');
            if (modal) {
                document.body.removeChild(modal);
                document.body.style.overflow = '';
                document.removeEventListener('keydown', handleEscapeKey);
            }
        }

        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeChartsModal();
            }
        }

        // Calculate average scores for given number of recent rounds
        function calculateAverageScores(numRounds) {
            if (rounds.length === 0) return { eggman: 0, george: 0, chris: 0 };
            
            const recentRounds = rounds.slice(0, Math.min(numRounds, rounds.length));
            let eggmanTotal = 0, georgeTotal = 0, chrisTotal = 0;
            
            recentRounds.forEach(round => {
                eggmanTotal += calculateRoundTotal(round.eggman);
                georgeTotal += calculateRoundTotal(round.george);
                chrisTotal += calculateRoundTotal(round.chris);
            });
            
            const actualRounds = recentRounds.length;
            return {
                eggman: actualRounds > 0 ? (eggmanTotal / actualRounds).toFixed(1) : 0,
                george: actualRounds > 0 ? (georgeTotal / actualRounds).toFixed(1) : 0,
                chris: actualRounds > 0 ? (chrisTotal / actualRounds).toFixed(1) : 0,
                actualRounds: actualRounds
            };
        }

        function updateAverageScoresTable() {
            const tableContainer = document.getElementById('averageScoresTable');
            if (!tableContainer) return;
            
            const periods = [
                { label: 'Last 3 Rounds', rounds: 3, icon: 'üî•' },
                { label: 'Last 8 Rounds', rounds: 8, icon: 'üìà' },
                { label: 'Last 15 Rounds', rounds: 15, icon: 'üìä' }
            ];
            
            let tableHTML = `
                <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-600 flex-1">
                    <table class="w-full text-sm">
                        <thead class="bg-gradient-to-r from-primary to-purple-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold">Period</th>
                                <th class="px-4 py-3 text-center font-semibold">Eggman</th>
                                <th class="px-4 py-3 text-center font-semibold">George</th>
                                <th class="px-4 py-3 text-center font-semibold">Chris</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            periods.forEach((period, index) => {
                const averages = calculateAverageScores(period.rounds);
                const rowClass = index % 2 === 0 
                    ? 'bg-white dark:bg-gray-800' 
                    : 'bg-gray-50 dark:bg-gray-750';
                
                // Find highest average for this period
                const scores = [
                    { player: 'eggman', score: parseFloat(averages.eggman) },
                    { player: 'george', score: parseFloat(averages.george) },
                    { player: 'chris', score: parseFloat(averages.chris) }
                ];
                scores.sort((a, b) => b.score - a.score);
                const topPlayer = scores[0].player;
                
                const isDataAvailable = averages.actualRounds >= Math.min(period.rounds, rounds.length);
                
                tableHTML += `
                    <tr class="${rowClass} hover:bg-blue-50 dark:hover:bg-gray-600 transition-colors">
                        <td class="px-4 py-4 font-medium text-gray-900 dark:text-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${period.icon}</span>
                                <div>
                                    <div>${period.label}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                        ${averages.actualRounds} of ${period.rounds} rounds
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex flex-col items-center">
                                <span class="text-lg font-bold ${topPlayer === 'eggman' ? 'text-blue-600 dark:text-blue-400 animate-glow' : 'text-gray-700 dark:text-gray-300'}">${averages.eggman}</span>
                                ${topPlayer === 'eggman' && isDataAvailable ? '<span class="text-xs text-yellow-500">üëë</span>' : ''}
                            </div>
                        </td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex flex-col items-center">
                                <span class="text-lg font-bold ${topPlayer === 'george' ? 'text-green-600 dark:text-green-400 animate-glow' : 'text-gray-700 dark:text-gray-300'}">${averages.george}</span>
                                ${topPlayer === 'george' && isDataAvailable ? '<span class="text-xs text-yellow-500">üëë</span>' : ''}
                            </div>
                        </td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex flex-col items-center">
                                <span class="text-lg font-bold ${topPlayer === 'chris' ? 'text-purple-600 dark:text-purple-400 animate-glow' : 'text-gray-700 dark:text-gray-300'}">${averages.chris}</span>
                                ${topPlayer === 'chris' && isDataAvailable ? '<span class="text-xs text-yellow-500">üëë</span>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-500 dark:text-gray-400 text-center">
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-yellow-500">üëë</span>
                        <span>Highest average for period</span>
                    </div>
                </div>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        function updateTable() {
            updateDesktopTable();
            updateMobileTable();
        }

        function updateDesktopTable() {
            const tbody = document.getElementById('scoreTableBodyDesktop');
            tbody.innerHTML = '';
            
            rounds.forEach((round, index) => {
                const isCollapsed = collapsedRounds.has(index);
                
                // Create header row with round info and toggle button
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-gray-50 dark:bg-gray-700 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors';
                headerRow.onclick = () => toggleRound(index);
                
                const eggmanTotal = calculateRoundTotal(round.eggman);
                const georgeTotal = calculateRoundTotal(round.george);
                const chrisTotal = calculateRoundTotal(round.chris);
                
                const expandIcon = isCollapsed ? 
                    '<svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' :
                    '<svg class="w-4 h-4 transform transition-transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                
                headerRow.innerHTML = `
                    <td class="px-2 py-3 font-medium">
                        <div class="flex items-center gap-2">
                            ${expandIcon}
                            Round ${round.round}
                        </div>
                    </td>
                    <td colspan="6" class="px-2 py-3 text-center font-medium border-l border-gray-200 dark:border-gray-600">
                        Total: ${eggmanTotal}
                    </td>
                    <td colspan="6" class="px-2 py-3 text-center font-medium border-l border-gray-200 dark:border-gray-600">
                        Total: ${georgeTotal}
                    </td>
                    <td colspan="6" class="px-2 py-3 text-center font-medium border-l border-gray-200 dark:border-gray-600">
                        Total: ${chrisTotal}
                    </td>
                `;
                
                tbody.appendChild(headerRow);
                
                // Add detail row if not collapsed
                if (!isCollapsed) {
                    const detailRow = document.createElement('tr');
                    detailRow.className = 'border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700';
                    
                    detailRow.innerHTML = `
                        <td class="px-2 py-3"></td>
                        ${createPlayerCells('eggman', round.eggman, index, eggmanTotal)}
                        ${createPlayerCells('george', round.george, index, georgeTotal)}
                        ${createPlayerCells('chris', round.chris, index, chrisTotal)}
                    `;
                    
                    tbody.appendChild(detailRow);
                }
            });
        }

        function updateMobileTable() {
            const container = document.getElementById('scoreTableMobile');
            container.innerHTML = '';
            
            rounds.forEach((round, index) => {
                const isCollapsed = collapsedRounds.has(index);
                const card = document.createElement('div');
                card.className = 'border-b border-gray-200 dark:border-gray-600';
                
                const eggmanTotal = calculateRoundTotal(round.eggman);
                const georgeTotal = calculateRoundTotal(round.george);
                const chrisTotal = calculateRoundTotal(round.chris);
                
                const expandIcon = isCollapsed ? 
                    '<svg class="w-5 h-5 transform transition-transform text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' :
                    '<svg class="w-5 h-5 transform transition-transform rotate-90 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                
                const headerContent = `
                    <div class="p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" onclick="toggleRound(${index})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                ${expandIcon}
                                <span class="font-semibold text-lg">Round ${round.round}</span>
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                E:${eggmanTotal} | G:${georgeTotal} | C:${chrisTotal}
                            </div>
                        </div>
                    </div>
                `;
                
                const detailContent = isCollapsed ? '' : `
                    <div class="px-4 pb-4">
                        <div class="space-y-4">
                            ${createMobilePlayerCard('Eggman', 'eggman', round.eggman, index, eggmanTotal, '#3B82F6')}
                            ${createMobilePlayerCard('George üëë', 'george', round.george, index, georgeTotal, '#10B981')}
                            ${createMobilePlayerCard('Chris', 'chris', round.chris, index, chrisTotal, '#8B5CF6')}
                        </div>
                    </div>
                `;
                
                card.innerHTML = headerContent + detailContent;
                container.appendChild(card);
            });
        }

        function createMobilePlayerCard(playerDisplayName, playerName, playerData, roundIndex, total, color) {
            const readonly = isAdminMode ? '' : 'readonly';
            const disabled = isAdminMode ? '' : 'disabled';
            const inputClass = `w-16 px-2 py-2 text-center text-base border rounded ${isAdminMode ? 'bg-white dark:bg-gray-700' : 'bg-gray-100 dark:bg-gray-600'} border-gray-300 dark:border-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none`;
            
            return `
                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <div class="font-medium" style="color: ${color}">${playerDisplayName}</div>
                        <div class="font-bold text-lg">${total}</div>
                    </div>
                    <div class="grid grid-cols-5 gap-2 text-xs">
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Win</div>
                            <input type="number" value="${playerData.win}" min="0" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'win', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Place</div>
                            <input type="number" value="${playerData.place}" min="0" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'place', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">H.Odds</div>
                            <input type="number" value="${playerData.highestOdds}" min="0" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'highestOdds', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Bonus</div>
                            <input type="number" value="${playerData.bonus}" min="-99" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'bonus', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Fav Backer</div>
                            <input type="checkbox" ${playerData.favBacker ? 'checked' : ''} ${disabled}
                                   class="w-5 h-5 text-primary border-gray-300 dark:border-gray-500 rounded focus:ring-primary dark:focus:ring-primary dark:focus:ring-offset-gray-800 focus:ring-2 ${isAdminMode ? '' : 'opacity-50'}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'favBacker', this.checked); updateTable();">
                        </div>
                    </div>
                </div>
            `;
        }

        function createPlayerCells(playerName, playerData, roundIndex, total) {
            const borderClass = playerName === 'eggman' ? '' : 'border-l border-gray-200 dark:border-gray-600';
            const readonly = isAdminMode ? '' : 'readonly';
            const disabled = isAdminMode ? '' : 'disabled';
            const inputClass = `w-12 px-1 py-1 text-center text-base border rounded ${isAdminMode ? 'bg-white dark:bg-gray-700' : 'bg-gray-100 dark:bg-gray-600'} border-gray-300 dark:border-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none`;
            
            return `
                <td class="px-2 py-2 ${borderClass}">
                    <input type="number" value="${playerData.win}" min="0" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'win', this.value)">
                </td>
                <td class="px-2 py-2">
                    <input type="number" value="${playerData.place}" min="0" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'place', this.value)">
                </td>
                <td class="px-2 py-2">
                    <input type="number" value="${playerData.highestOdds}" min="0" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'highestOdds', this.value)">
                </td>
                <td class="px-2 py-2">
                    <input type="number" value="${playerData.bonus}" min="-99" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'bonus', this.value)">
                </td>
                <td class="px-2 py-2 text-center">
                    <input type="checkbox" ${playerData.favBacker ? 'checked' : ''} ${disabled}
                           class="w-4 h-4 text-primary border-gray-300 dark:border-gray-500 rounded focus:ring-primary dark:focus:ring-primary dark:focus:ring-offset-gray-800 focus:ring-2 ${isAdminMode ? '' : 'opacity-50'}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'favBacker', this.checked)">
                </td>
                <td class="px-2 py-2 font-medium">${total}</td>
            `;
        }

        function updateTotals() {
            updateDynamicStandings();
        }

        function updateDynamicStandings() {
            let eggmanTotal = 0, georgeTotal = 0, chrisTotal = 0;
            let eggmanFavCount = 0, georgeFavCount = 0, chrisFavCount = 0;
            
            rounds.forEach(round => {
                eggmanTotal += calculateRoundTotal(round.eggman);
                georgeTotal += calculateRoundTotal(round.george);
                chrisTotal += calculateRoundTotal(round.chris);
                
                if (round.eggman.favBacker) eggmanFavCount++;
                if (round.george.favBacker) georgeFavCount++;
                if (round.chris.favBacker) chrisFavCount++;
            });

            // Create players array with totals and sort by score
            const players = [
                { 
                    name: 'Eggman', 
                    key: 'eggman',
                    total: eggmanTotal, 
                    favCount: eggmanFavCount,
                    color: { primary: '#3B82F6', secondary: '#60A5FA' },
                    gradientFrom: 'from-blue-50',
                    gradientTo: 'to-blue-100',
                    gradientFromDark: 'dark:from-blue-900/30',
                    gradientToDark: 'dark:to-blue-800/30',
                    textColor: 'text-blue-600 dark:text-blue-400',
                    secondaryTextColor: 'text-blue-500 dark:text-blue-300'
                },
                { 
                    name: 'George', 
                    key: 'george',
                    total: georgeTotal, 
                    favCount: georgeFavCount,
                    color: { primary: '#10B981', secondary: '#34D399' },
                    gradientFrom: 'from-green-50',
                    gradientTo: 'to-green-100',
                    gradientFromDark: 'dark:from-green-900/30',
                    gradientToDark: 'dark:to-green-800/30',
                    textColor: 'text-green-600 dark:text-green-400',
                    secondaryTextColor: 'text-green-500 dark:text-green-300'
                },
                { 
                    name: 'Chris', 
                    key: 'chris',
                    total: chrisTotal, 
                    favCount: chrisFavCount,
                    color: { primary: '#8B5CF6', secondary: '#A78BFA' },
                    gradientFrom: 'from-purple-50',
                    gradientTo: 'to-purple-100',
                    gradientFromDark: 'dark:from-purple-900/30',
                    gradientToDark: 'dark:to-purple-800/30',
                    textColor: 'text-purple-600 dark:text-purple-400',
                    secondaryTextColor: 'text-purple-500 dark:text-purple-300'
                }
            ];

            // Sort players by total score (descending)
            players.sort((a, b) => b.total - a.total);

            // Calculate position changes
            const currentPositions = {};
            players.forEach((player, index) => {
                currentPositions[player.key] = index + 1;
            });

            const standingsContainer = document.getElementById('dynamicStandings');
            standingsContainer.innerHTML = '';

            players.forEach((player, index) => {
                const position = index + 1;
                const previousPosition = previousPositions[player.key] || position;
                const positionChange = previousPosition - position;

                // Generate position indicator and medal
                let positionIndicator = '';
                let medal = '';
                let specialAnimation = '';

                if (position === 1) {
                    medal = '<span class="text-2xl animate-bounce-slow">ü•á</span>';
                    specialAnimation = 'animate-pulse-slow';
                } else if (position === 2) {
                    medal = '<span class="text-2xl">ü•à</span>';
                } else if (position === 3) {
                    medal = '<span class="text-2xl">ü•â</span>';
                }

                // Position change arrows - only show if there are previous positions and it's not the first load
                if (Object.keys(previousPositions).length > 0) {
                    if (positionChange > 0) {
                        positionIndicator = '<span class="inline-flex items-center text-green-500 text-sm font-medium animate-bounce">' +
                            '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">' +
                            '<path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>' +
                            '</svg>' +
                            '+' + positionChange +
                            '</span>';
                    } else if (positionChange < 0) {
                        positionIndicator = '<span class="inline-flex items-center text-red-500 text-sm font-medium">' +
                            '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">' +
                            '<path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>' +
                            '</svg>' +
                            positionChange +
                            '</span>';
                    } else {
                        positionIndicator = '<span class="inline-flex items-center text-gray-500 text-sm font-medium">' +
                            '<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">' +
                            '<path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path>' +
                            '</svg>' +
                            '-' +
                            '</span>';
                    }
                }

                // Create the standings card
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br ' + player.gradientFrom + ' ' + player.gradientTo + ' ' + 
                                player.gradientFromDark + ' ' + player.gradientToDark + ' p-4 rounded-lg transform transition-all duration-500 hover:scale-105';
                
                if (specialAnimation) {
                    card.className += ' ' + specialAnimation;
                }
                
                // Add special border for leader
                if (position === 1) {
                    card.className += ' ring-2 ring-yellow-400 dark:ring-yellow-300 shadow-lg';
                }

                const leaderBadge = position === 1 ? '<span class="text-yellow-600 dark:text-yellow-400 font-bold animate-wiggle">üëë LEADER</span>' : '';
                const tequilaBadge = position === 2 ? '<span class="text-yellow-600 dark:text-yellow-400 font-bold animate-wiggle">ü•É </span>' : '';
                const tequilathirdBadge = position === 3 ? '<span class="text-yellow-600 dark:text-yellow-400 font-bold animate-wiggle">ü•Éü•É</span>' : '';

                card.innerHTML = 
                    '<div class="flex items-center justify-between mb-3">' +
                        '<div class="flex items-center space-x-3">' +
                            '<div class="text-2xl font-bold ' + player.textColor + '">' + player.name + '</div>' +
                            medal +
                        '</div>' +
                        positionIndicator +
                    '</div>' +
                    '<div class="text-3xl font-bold ' + player.textColor + ' mb-2">' + player.total + '</div>' +
                    '<div class="text-xs ' + player.secondaryTextColor + ' flex items-center justify-between">' +
                        '<span>Fav Backer: ' + player.favCount + '</span>' +
                        leaderBadge + tequilaBadge + tequilathirdBadge +
                    '</div>';

                standingsContainer.appendChild(card);
            });

            // Update previous positions for next comparison (only if we have existing data)
            if (rounds.length > 0) {
                // Store positions after a small delay to allow for visual feedback
                setTimeout(() => {
                    previousPositions = { ...currentPositions };
                }, 100);
            }
        }

        function initCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#D1D5DB' : '#374151';
            const gridColor = isDark ? '#374151' : '#E5E7EB';
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Eggman',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'George',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Chris',
                            data: [],
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });

            // Fav Backer Chart (Bar Chart)
            const favBackerCtx = document.getElementById('favBackerChart').getContext('2d');
            favBackerChart = new Chart(favBackerCtx, {
                type: 'bar',
                data: {
                    labels: ['Eggman', 'George', 'Chris'],
                    datasets: [{
                        label: 'Fav Backer Count',
                        data: [0, 0, 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6'],
                        borderColor: ['#1E40AF', '#047857', '#6D28D9'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: textColor,
                                stepSize: 1
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Only update charts if they exist (modal is open)
            if (!trendChart || !favBackerChart) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#D1D5DB' : '#374151';
            const gridColor = isDark ? '#374151' : '#E5E7EB';
            
            // Update colors for dark mode
            [trendChart, favBackerChart].forEach(chart => {
                chart.options.scales.y.ticks.color = textColor;
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.y.grid.color = gridColor;
                chart.options.scales.x.grid.color = gridColor;
                chart.options.plugins.legend.labels.color = textColor;
            });
            
            // Update trend data - reverse order for correct chronological display
            const sortedRounds = [...rounds].reverse();
            const labels = sortedRounds.map((_, index) => `Round ${index + 1}`);
            let eggmanCumulative = 0, georgeCumulative = 0, chrisCumulative = 0;
            let eggmanFavCount = 0, georgeFavCount = 0, chrisFavCount = 0;
            
            const eggmanData = sortedRounds.map(round => {
                eggmanCumulative += calculateRoundTotal(round.eggman);
                return eggmanCumulative;
            });
            
            const georgeData = sortedRounds.map(round => {
                georgeCumulative += calculateRoundTotal(round.george);
                return georgeCumulative;
            });
            
            const chrisData = sortedRounds.map(round => {
                chrisCumulative += calculateRoundTotal(round.chris);
                return chrisCumulative;
            });

            // Calculate total fav backer counts (not cumulative for bar chart)
            rounds.forEach(round => {
                if (round.eggman.favBacker) eggmanFavCount++;
                if (round.george.favBacker) georgeFavCount++;
                if (round.chris.favBacker) chrisFavCount++;
            });
            
            // Update trend chart
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = eggmanData;
            trendChart.data.datasets[1].data = georgeData;
            trendChart.data.datasets[2].data = chrisData;
            
            // Update fav backer bar chart with total counts
            favBackerChart.data.datasets[0].data = [eggmanFavCount, georgeFavCount, chrisFavCount];
            
            trendChart.update();
            favBackerChart.update();

            // Update average scores table
            updateAverageScoresTable();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initPusher();
            loadInitialData();
        });
    </script>
</body>
</html>