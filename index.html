<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Scoring Tracker</title>
    <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC8'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-primary dark:text-primary-light">ITV7 Tracker</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Track wins, places, highest odds, and bonus points</p>
                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    <span id="connectionStatus" class="inline-flex items-center">
                        <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                        Connecting...
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="adminMode" class="sr-only">
                    <div class="relative">
                        <div class="block bg-gray-300 dark:bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform"></div>
                    </div>
                    <span class="ml-3 text-sm font-medium">Admin Mode</span>
                </label>
                <button onclick="addRound()" id="addRoundBtn" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Add Round
                </button>
            </div>
        </div>

        <!-- Scoring Rules -->
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6">
            <h3 class="font-semibold text-sm mb-2">Scoring Rules:</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                <div class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Win: 3 points</div>
                <div class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>Place: 1 point</div>
                <div class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>Highest Odds: 5 points</div>
            </div>
        </div>

        <!-- Current Standings -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 p-4 rounded-lg">
                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="eggmanTotal">0</div>
                <div class="text-sm text-blue-600 dark:text-blue-400">Eggman</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 p-4 rounded-lg">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="georgeTotal">0</div>
                <div class="text-sm text-green-600 dark:text-green-400">George ðŸ‘‘</div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 p-4 rounded-lg">
                <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="chrisTotal">0</div>
                <div class="text-sm text-purple-600 dark:text-purple-400">Chris</div>
            </div>
        </div>

        <!-- Charts Toggle Button -->
        <div class="mb-6">
            <button onclick="toggleCharts()" class="w-full sm:w-auto bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                <svg id="chartsIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span id="chartsButtonText">Show Charts & Trends</span>
            </button>
        </div>

        <!-- Score Table - Mobile Optimized -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden mb-6">
            <!-- Desktop Table -->
            <div class="hidden lg:block overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 dark:text-gray-300 w-16">Round</th>
                            <th colspan="5" class="px-2 py-3 text-center font-medium text-gray-600 dark:text-gray-300 border-l border-gray-200 dark:border-gray-600">Eggman</th>
                            <th colspan="5" class="px-2 py-3 text-center font-medium text-gray-600 dark:text-gray-300 border-l border-gray-200 dark:border-gray-600">George ðŸ‘‘</th>
                            <th colspan="5" class="px-2 py-3 text-center font-medium text-gray-600 dark:text-gray-300 border-l border-gray-200 dark:border-gray-600">Chris</th>
                        </tr>
                        <tr class="bg-gray-100 dark:bg-gray-600">
                            <th class="px-2 py-2"></th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">W</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">P</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">HO</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">B</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">Tot</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400 border-l border-gray-200 dark:border-gray-500">W</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">P</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">HO</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">B</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">Tot</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400 border-l border-gray-200 dark:border-gray-500">W</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">P</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">HO</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">B</th>
                            <th class="px-1 py-2 text-xs text-gray-500 dark:text-gray-400">Tot</th>
                        </tr>
                    </thead>
                    <tbody id="scoreTableBodyDesktop">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="lg:hidden" id="scoreTableMobile">
                <!-- Cards will be added dynamically -->
            </div>
        </div>

        <!-- Charts - Hidden by default -->
        <div id="chartsSection" class="hidden grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Cumulative Score Trend</h3>
                <canvas id="trendChart" width="400" height="200"></canvas>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Score Breakdown</h3>
                <canvas id="breakdownChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let rounds = [];
        let isAdminMode = false;
        let trendChart, breakdownChart;
        let pusher, channel;

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateCharts();
        });

        // Initialize Pusher connection
        function initPusher() {
            try {
                pusher = new Pusher('34c3cbec9bc210bcb8c0', {
                    cluster: 'eu'
                });

                channel = pusher.subscribe('score-channel');
                
                pusher.connection.bind('connected', function() {
                    updateConnectionStatus('connected');
                });
                
                pusher.connection.bind('disconnected', function() {
                    updateConnectionStatus('disconnected');
                });
                
                pusher.connection.bind('failed', function() {
                    updateConnectionStatus('failed');
                });

                channel.bind('score-updated', function(data) {
                    if (data.scoreData && data.scoreData.rounds) {
                        rounds = data.scoreData.rounds;
                        updateTable();
                        updateTotals();
                        updateCharts();
                    }
                });
            } catch (error) {
                console.error('Failed to initialize Pusher:', error);
                updateConnectionStatus('failed');
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const dot = statusElement.querySelector('span');
            
            switch(status) {
                case 'connected':
                    dot.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Connected';
                    break;
                case 'disconnected':
                    dot.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>Disconnected';
                    break;
                case 'failed':
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>Connection Failed';
                    break;
                default:
                    dot.className = 'w-2 h-2 bg-gray-400 rounded-full mr-2';
                    statusElement.innerHTML = '<span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>Connecting...';
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                const response = await fetch('/.netlify/functions/update-score');
                const data = await response.json();
                if (data.scoreData && data.scoreData.rounds) {
                    rounds = data.scoreData.rounds;
                    updateTable();
                    updateTotals();
                    updateCharts();
                }
            } catch (error) {
                console.error('Failed to load initial data:', error);
            }
        }

        // Send score update to backend
        async function sendScoreUpdate() {
            if (!isAdminMode) return;
            
            try {
                await fetch('/.netlify/functions/update-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scoreData: { 
                            rounds: rounds,
                            lastUpdated: new Date().toISOString()
                        } 
                    })
                });
            } catch (error) {
                console.error('Failed to send score update:', error);
            }
        }

        // Password modal functions
        function showPasswordModal() {
            const modal = document.createElement('div');
            modal.id = 'passwordModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Admin Access Required</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Please enter the password to enable admin mode:</p>
                    <input type="password" id="passwordInput" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-primary focus:ring-1 focus:ring-primary outline-none mb-4" placeholder="Enter password">
                    <div id="passwordError" class="text-red-500 text-sm mb-4 hidden">Incorrect password. Please try again.</div>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closePasswordModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
                        <button onclick="checkPassword()" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg transition-colors">Submit</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on input and setup enter key handler
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.focus();
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        }

        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            // Reset toggle if password was wrong
            const adminToggle = document.getElementById('adminMode');
            adminToggle.checked = isAdminMode;
        }

        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const errorDiv = document.getElementById('passwordError');
            const password = passwordInput.value;
            
            if (password === 'Geo123geo') {
                isAdminMode = true;
                updateAdminToggleAppearance(true);
                document.getElementById('addRoundBtn').disabled = false;
                updateTable();
                closePasswordModal();
            } else {
                errorDiv.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function updateAdminToggleAppearance(enabled) {
            const dot = document.querySelector('.dot');
            const bg = document.querySelector('.block');
            if (enabled) {
                dot.style.transform = 'translateX(24px)';
                bg.style.backgroundColor = '#5D5CDE';
            } else {
                dot.style.transform = 'translateX(0)';
                bg.style.backgroundColor = '';
            }
        }

        // Admin mode toggle
        const adminToggle = document.getElementById('adminMode');
        adminToggle.addEventListener('change', function() {
            if (this.checked && !isAdminMode) {
                // Show password modal when trying to enable admin mode
                showPasswordModal();
            } else if (!this.checked && isAdminMode) {
                // Disable admin mode
                isAdminMode = false;
                document.getElementById('addRoundBtn').disabled = true;
                updateAdminToggleAppearance(false);
                updateTable();
            }
        });

        function addRound() {
            if (!isAdminMode) return;
            
            const roundNumber = rounds.length + 1;
            const newRound = {
                round: roundNumber,
                eggman: { win: '', place: '', highestOdds: '', bonus: '' },
                george: { win: '', place: '', highestOdds: '', bonus: '' },
                chris: { win: '', place: '', highestOdds: '', bonus: '' }
            };
            
            rounds.unshift(newRound);
            updateTable();
            updateTotals();
            updateCharts();
            sendScoreUpdate();
        }

        function calculateRoundTotal(player) {
            const win = parseInt(player.win) || 0;
            const place = parseInt(player.place) || 0;
            const highestOdds = parseInt(player.highestOdds) || 0;
            const bonus = parseInt(player.bonus) || 0;
            return (win * 3) + (place * 1) + (highestOdds * 5) + bonus;
        }

        function updateRoundData(roundIndex, player, field, value) {
            if (!isAdminMode) return;
            
            rounds[roundIndex][player][field] = value === '' ? '' : (parseInt(value) || '');
            updateTotals();
            updateCharts();
            sendScoreUpdate();
        }

        function toggleCharts() {
            const chartsSection = document.getElementById('chartsSection');
            const chartsIcon = document.getElementById('chartsIcon');
            const chartsButtonText = document.getElementById('chartsButtonText');
            
            if (chartsSection.classList.contains('hidden')) {
                chartsSection.classList.remove('hidden');
                chartsSection.classList.add('grid');
                chartsIcon.style.transform = 'rotate(180deg)';
                chartsButtonText.textContent = 'Hide Charts & Trends';
                // Initialize charts if they haven't been created yet
                if (!trendChart || !breakdownChart) {
                    initCharts();
                }
                updateCharts();
            } else {
                chartsSection.classList.add('hidden');
                chartsSection.classList.remove('grid');
                chartsIcon.style.transform = 'rotate(0deg)';
                chartsButtonText.textContent = 'Show Charts & Trends';
            }
        }

        function updateTable() {
            updateDesktopTable();
            updateMobileTable();
        }

        function updateDesktopTable() {
            const tbody = document.getElementById('scoreTableBodyDesktop');
            tbody.innerHTML = '';
            
            rounds.forEach((round, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700';
                
                const eggmanTotal = calculateRoundTotal(round.eggman);
                const georgeTotal = calculateRoundTotal(round.george);
                const chrisTotal = calculateRoundTotal(round.chris);
                
                row.innerHTML = `
                    <td class="px-2 py-3 font-medium">${round.round}</td>
                    ${createPlayerCells('eggman', round.eggman, index, eggmanTotal)}
                    ${createPlayerCells('george', round.george, index, georgeTotal)}
                    ${createPlayerCells('chris', round.chris, index, chrisTotal)}
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateMobileTable() {
            const container = document.getElementById('scoreTableMobile');
            container.innerHTML = '';
            
            rounds.forEach((round, index) => {
                const card = document.createElement('div');
                card.className = 'p-4 border-b border-gray-200 dark:border-gray-600';
                
                const eggmanTotal = calculateRoundTotal(round.eggman);
                const georgeTotal = calculateRoundTotal(round.george);
                const chrisTotal = calculateRoundTotal(round.chris);
                
                card.innerHTML = `
                    <div class="font-semibold text-lg mb-3 text-center">Round ${round.round}</div>
                    <div class="space-y-4">
                        ${createMobilePlayerCard('Eggman', 'eggman', round.eggman, index, eggmanTotal, '#3B82F6')}
                        ${createMobilePlayerCard('George ðŸ‘‘', 'george', round.george, index, georgeTotal, '#10B981')}
                        ${createMobilePlayerCard('Chris', 'chris', round.chris, index, chrisTotal, '#8B5CF6')}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function createMobilePlayerCard(playerDisplayName, playerName, playerData, roundIndex, total, color) {
            const readonly = isAdminMode ? '' : 'readonly';
            const inputClass = `w-16 px-2 py-2 text-center text-base border rounded ${isAdminMode ? 'bg-white dark:bg-gray-700' : 'bg-gray-100 dark:bg-gray-600'} border-gray-300 dark:border-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none`;
            
            return `
                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <div class="font-medium" style="color: ${color}">${playerDisplayName}</div>
                        <div class="font-bold text-lg">${total}</div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Win</div>
                            <input type="number" value="${playerData.win}" min="0" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'win', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Place</div>
                            <input type="number" value="${playerData.place}" min="0" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'place', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">H.Odds</div>
                            <input type="number" value="${playerData.highestOdds}" min="0" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'highestOdds', this.value); updateTable();">
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 dark:text-gray-400 mb-1">Bonus</div>
                            <input type="number" value="${playerData.bonus}" min="-99" max="99" ${readonly}
                                   class="${inputClass}"
                                   onchange="updateRoundData(${roundIndex}, '${playerName}', 'bonus', this.value); updateTable();">
                        </div>
                    </div>
                </div>
            `;
        }

        function createPlayerCells(playerName, playerData, roundIndex, total) {
            const borderClass = playerName === 'eggman' ? '' : 'border-l border-gray-200 dark:border-gray-600';
            const readonly = isAdminMode ? '' : 'readonly';
            const inputClass = `w-12 px-1 py-1 text-center text-base border rounded ${isAdminMode ? 'bg-white dark:bg-gray-700' : 'bg-gray-100 dark:bg-gray-600'} border-gray-300 dark:border-gray-500 focus:border-primary focus:ring-1 focus:ring-primary outline-none`;
            
            return `
                <td class="px-2 py-2 ${borderClass}">
                    <input type="number" value="${playerData.win}" min="0" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'win', this.value)">
                </td>
                <td class="px-2 py-2">
                    <input type="number" value="${playerData.place}" min="0" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'place', this.value)">
                </td>
                <td class="px-2 py-2">
                    <input type="number" value="${playerData.highestOdds}" min="0" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'highestOdds', this.value)">
                </td>
                <td class="px-2 py-2">
                    <input type="number" value="${playerData.bonus}" min="-99" max="99" ${readonly}
                           class="${inputClass}"
                           onchange="updateRoundData(${roundIndex}, '${playerName}', 'bonus', this.value)">
                </td>
                <td class="px-2 py-2 font-medium">${total}</td>
            `;
        }

        function updateTotals() {
            let eggmanTotal = 0, georgeTotal = 0, chrisTotal = 0;
            
            rounds.forEach(round => {
                eggmanTotal += calculateRoundTotal(round.eggman);
                georgeTotal += calculateRoundTotal(round.george);
                chrisTotal += calculateRoundTotal(round.chris);
            });
            
            document.getElementById('eggmanTotal').textContent = eggmanTotal;
            document.getElementById('georgeTotal').textContent = georgeTotal;
            document.getElementById('chrisTotal').textContent = chrisTotal;
        }

        function initCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#D1D5DB' : '#374151';
            const gridColor = isDark ? '#374151' : '#E5E7EB';
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Eggman',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'George',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Chris',
                            data: [],
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });

            // Breakdown Chart
            const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
            breakdownChart = new Chart(breakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Eggman', 'George', 'Chris'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6'],
                        borderWidth: 2,
                        borderColor: isDark ? '#1F2937' : '#FFFFFF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!trendChart || !breakdownChart) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#D1D5DB' : '#374151';
            const gridColor = isDark ? '#374151' : '#E5E7EB';
            
            // Update colors for dark mode
            trendChart.options.scales.y.ticks.color = textColor;
            trendChart.options.scales.x.ticks.color = textColor;
            trendChart.options.scales.y.grid.color = gridColor;
            trendChart.options.scales.x.grid.color = gridColor;
            trendChart.options.plugins.legend.labels.color = textColor;
            
            breakdownChart.options.plugins.legend.labels.color = textColor;
            breakdownChart.data.datasets[0].borderColor = isDark ? '#1F2937' : '#FFFFFF';
            
            // Update trend data - reverse order for correct chronological display
            const sortedRounds = [...rounds].reverse();
            const labels = sortedRounds.map((_, index) => `Round ${index + 1}`);
            let eggmanCumulative = 0, georgeCumulative = 0, chrisCumulative = 0;
            
            const eggmanData = sortedRounds.map(round => {
                eggmanCumulative += calculateRoundTotal(round.eggman);
                return eggmanCumulative;
            });
            
            const georgeData = sortedRounds.map(round => {
                georgeCumulative += calculateRoundTotal(round.george);
                return georgeCumulative;
            });
            
            const chrisData = sortedRounds.map(round => {
                chrisCumulative += calculateRoundTotal(round.chris);
                return chrisCumulative;
            });
            
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = eggmanData;
            trendChart.data.datasets[1].data = georgeData;
            trendChart.data.datasets[2].data = chrisData;
            
            // Update breakdown data
            const finalTotals = [
                eggmanCumulative,
                georgeCumulative,
                chrisCumulative
            ];
            breakdownChart.data.datasets[0].data = finalTotals;
            
            trendChart.update();
            breakdownChart.update();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            initPusher();
            loadInitialData();
        });
    </script>
</body>
</html>
